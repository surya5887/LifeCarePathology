{% extends 'base.html' %}
{% block title %}Register — Life Care Pathology Lab{% endblock %}

{% block content %}
<section class="auth-section">
    <div class="auth-container">
        <div class="auth-card">
            <div class="auth-header">
                <div class="auth-icon"><i class="fas fa-user-plus"></i></div>
                <h2>Create Account</h2>
                <p>Register to book tests and access your reports</p>
            </div>
            <form method="POST" action="{{ url_for('auth.register') }}" class="auth-form" enctype="multipart/form-data">
                <div class="form-group">
                    <label for="name">Full Name</label>
                    <div class="input-icon-wrapper">
                        <i class="fas fa-user"></i>
                        <input type="text" id="name" name="name" placeholder="Enter your full name" required>
                    </div>
                </div>
                <div class="form-group">
                    <label for="email">Email Address</label>
                    <div class="input-group" style="display: flex; gap: 10px;">
                        <div class="input-icon-wrapper" style="flex: 1;">
                            <i class="fas fa-envelope"></i>
                            <input type="email" id="email" name="email" placeholder="your@email.com" required>
                        </div>
                        <button type="button" id="sendOtpBtn" class="btn btn-outline-primary" onclick="sendOtp()" style="padding: 0 15px; font-size: 14px; white-space: nowrap;">
                            Verify
                        </button>
                    </div>
                    <small id="emailHelp" class="form-text text-muted" style="display: block; margin-top: 5px;">
                        Click verify to receive an OTP.
                    </small>
                </div>

                <!-- OTP Section (Hidden initially) -->
                <div id="otpSection" style="display: none; margin-bottom: 20px; background: #f8f9fa; padding: 15px; border-radius: 8px; border: 1px solid #e9ecef;">
                    <label for="otp" style="font-size: 13px; font-weight: 600; color: #495057;">Enter Verification Code</label>
                    <div style="display: flex; gap: 10px; margin-top: 5px;">
                        <input type="text" id="otp" name="otp" placeholder="6-digit OTP" maxlength="6" style="flex:1; padding: 8px; border: 1px solid #ced4da; border-radius: 4px; text-align: center; letter-spacing: 2px;">
                        <button type="button" class="btn btn-primary" onclick="verifyOtp()" style="padding: 0 15px; font-size: 13px;">
                            Submit
                        </button>
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 10px; font-size: 12px;">
                        <span id="otpTimer" style="color: #666;">Resend in 60s</span>
                        <a href="javascript:void(0)" id="resendLink" onclick="sendOtp()" style="color: var(--primary); display: none; text-decoration: none; font-weight: 600;">Resend OTP</a>
                    </div>
                </div>

                <div class="form-group">
                    <label for="phone">Phone Number</label>
                    <div class="input-icon-wrapper">
                        <i class="fas fa-phone"></i>
                        <input type="tel" id="phone" name="phone" placeholder="+91 XXXXX XXXXX" required>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="password">Password</label>
                        <div class="input-icon-wrapper">
                            <i class="fas fa-lock"></i>
                            <input type="password" id="password" name="password" placeholder="Min 6 characters" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="confirm_password">Confirm Password</label>
                        <div class="input-icon-wrapper">
                            <i class="fas fa-lock"></i>
                            <input type="password" id="confirm_password" name="confirm_password" placeholder="Confirm password" required>
                        </div>
                    </div>
                </div>
                <button type="submit" id="submitBtn" class="btn btn-primary btn-block btn-lg" disabled style="opacity: 0.6; cursor: not-allowed;">
                    <i class="fas fa-user-plus"></i> Create Account
                </button>

            </form>

            <script>
                let timerOn = false;
                
                function sendOtp() {
                    const email = document.getElementById('email').value.trim();
                    const btn = document.getElementById('sendOtpBtn');
                    const help = document.getElementById('emailHelp');
                    
                    if (!email || !email.includes('@')) {
                        alert('Please enter a valid email address.');
                        return;
                    }

                    // Disable button logic
                    btn.disabled = true;
                    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Sending...';

                    fetch("{{ url_for('auth.send_otp') }}", {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ email: email })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            document.getElementById('otpSection').style.display = 'block';
                            help.innerHTML = '<span class="text-success"><i class="fas fa-check-circle"></i> OTP Sent! Check your email.</span>';
                            startTimer(60);
                            
                            // Reset button state but keep disabled for timer
                            btn.innerHTML = 'Sent';
                        } else {
                            alert(data.message);
                            btn.disabled = false;
                            btn.innerHTML = 'Verify';
                            help.innerHTML = `<span class="text-danger">${data.message}</span>`;
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('Something went wrong. Please try again.');
                        btn.disabled = false;
                        btn.innerHTML = 'Verify';
                    });
                }

                function verifyOtp() {
                    const email = document.getElementById('email').value.trim();
                    const otp = document.getElementById('otp').value.trim();
                    
                    if (otp.length !== 6) {
                        alert('Please enter a valid 6-digit OTP.');
                        return;
                    }

                    fetch("{{ url_for('auth.verify_otp') }}", {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ email: email, otp: otp })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            // Success UI
                            document.getElementById('otpSection').style.display = 'none';
                            const emailInput = document.getElementById('email');
                            emailInput.readOnly = true;
                            emailInput.style.borderColor = '#28a745';
                            emailInput.style.backgroundColor = '#e8f5e9';
                            
                            const btn = document.getElementById('sendOtpBtn');
                            btn.innerHTML = 'Verified <i class="fas fa-check"></i>';
                            btn.className = 'btn btn-success';
                            btn.disabled = true;

                            document.getElementById('emailHelp').style.display = 'none';
                            
                            // Enable Submit
                            const submitBtn = document.getElementById('submitBtn');
                            submitBtn.disabled = false;
                            submitBtn.style.opacity = '1';
                            submitBtn.style.cursor = 'pointer';
                            
                            alert('Email Verified Successfully! ✅');
                        } else {
                            alert(data.message);
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('Verification failed.');
                    });
                }

                function startTimer(duration) {
                    let timer = duration, minutes, seconds;
                    const display = document.getElementById('otpTimer');
                    const resendLink = document.getElementById('resendLink');
                    
                    resendLink.style.display = 'none';
                    display.style.display = 'block';
                    
                    const interval = setInterval(function () {
                        minutes = parseInt(timer / 60, 10);
                        seconds = parseInt(timer % 60, 10);

                        seconds = seconds < 10 ? "0" + seconds : seconds;

                        display.textContent = "Resend in " + seconds + "s";

                        if (--timer < 0) {
                            clearInterval(interval);
                            display.style.display = 'none';
                            resendLink.style.display = 'block';
                            
                            // Re-enable send button logic if needed, but here we use link
                            document.getElementById('sendOtpBtn').disabled = false;
                            document.getElementById('sendOtpBtn').innerHTML = 'Resend';
                        }
                    }, 1000);
                }
            </script>
            <div class="auth-footer">
                <p>Already have an account? <a href="{{ url_for('auth.login') }}">Login here</a></p>
            </div>
        </div>
    </div>
</section>
{% endblock %}
