{% extends 'admin/admin_base.html' %}
{% block title %}Report Preview — {{ report.report_id }}{% endblock %}
{% block page_title %}Report Preview{% endblock %}

{% block content %}
<style>
    /* ── Action bar ── */
    .preview-actions { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; align-items: center; justify-content: space-between; }
    .act-left { display: flex; gap: 10px; }
    .btn-act { padding: 10px 22px; border-radius: 10px; border: none; font-weight: 700;
        font-size: 13px; cursor: pointer; display: inline-flex; align-items: center; gap: 7px;
        transition: transform .2s; text-decoration: none; }
    .btn-act:hover { transform: translateY(-2px); }
    .btn-print { background: linear-gradient(135deg, #3B82F6, #2563EB); color: #fff; box-shadow: 0 4px 12px rgba(59,130,246,0.3); }
    .btn-dl { background: linear-gradient(135deg, #10B981, #059669); color: #fff; box-shadow: 0 4px 12px rgba(16,185,129,0.3); }
    .btn-back { background: rgba(255,255,255,0.08); color: #94A3B8; }

    /* ── Template Selector (Thumbnails) ── */
    .tpl-section { background: var(--admin-card-bg); border-radius: 12px; padding: 15px 20px; margin-bottom: 25px; }
    .tpl-header { font-size: 13px; font-weight: 700; color: #94A3B8; text-transform: uppercase; margin-bottom: 12px; display: flex; justify-content: space-between; }
    .tpl-thumbs { display: flex; gap: 12px; overflow-x: auto; padding-bottom: 5px; scrollbar-width: thin; }
    .tpl-thumbs::-webkit-scrollbar { height: 6px; }
    .tpl-thumbs::-webkit-scrollbar-thumb { background: #475569; border-radius: 3px; }
    
    .tpl-item { cursor: pointer; position: relative; flex-shrink: 0; transition: .2s; }
    .tpl-img { width: 70px; height: 90px; object-fit: cover; border-radius: 6px; border: 2px solid rgba(255,255,255,0.1); transition: .2s; opacity: 0.7; background: #fff; }
    .tpl-item:hover .tpl-img { opacity: 1; border-color: #64748B; }
    .tpl-item.active .tpl-img { opacity: 1; border-color: var(--admin-primary); box-shadow: 0 0 0 3px rgba(59,130,246,0.25); transform: translateY(-2px); }
    .tpl-name { font-size: 10px; text-align: center; margin-top: 4px; color: #94A3B8; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 70px; }

    /* ── A4 Page Styles ── */
    .report-container { display: flex; flex-direction: column; gap: 30px; padding-bottom: 50px; align-items: center; }
    
    .report-page {
        width: 210mm; /* A4 Width */
        height: 297mm; /* A4 Height */
        background: #fff; color: #000; position: relative;
        font-family: 'Segoe UI', Arial, sans-serif; font-size: 12px;
        box-shadow: 0 8px 30px rgba(0,0,0,0.4); border-radius: 2px;
        overflow: hidden; /* Hide anything outside */
        margin: 0 auto;
        box-sizing: border-box;
    }

    /* Template Background */
    .tpl-bg {
        position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        object-fit: fill; z-index: 0; pointer-events: none;
    }

    /* Safe Content Area */
    .page-content {
        position: relative; z-index: 1;
        /* Matches template holes: 54mm top, 56mm bottom */
        padding: 54mm 14mm 56mm 14mm; 
        height: 100%; box-sizing: border-box;
        display: flex; flex-direction: column;
    }

    /* Tables */
    .info-table, .results-table { width: 100%; border-collapse: collapse; border: 2px solid #1a1a2e; margin-bottom: 10px; }
    .info-table td { padding: 5px 8px; font-size: 11px; border: 1px solid #ccc; }
    .info-table .lbl { background: #1a1a2e; color: #fff; font-weight: 700; width: 15%; text-align: right; white-space: nowrap; }
    .info-table .val { background: #f8f9fc; font-weight: 600; width: 35%; }

    .section-header { background: #1a1a2e; color: #fff; text-align: center; padding: 6px 12px; font-size: 11px; font-weight: 800; text-transform: uppercase; border: 2px solid #1a1a2e; border-bottom: none; margin-top: 10px; }
    .section-header.first { margin-top: 0; }

    .results-table th { background: #1a1a2e; color: #fff; padding: 8px; font-size: 10px; text-transform: uppercase; border: 1px solid #333; }
    .results-table td { padding: 4px 8px; font-size: 11px; text-align: center; border: 1px solid #bbb; }
    .results-table tbody tr:nth-child(even) { background: #f0f4ff; }
    .results-table .p-name { text-align: left; font-weight: 600; padding-left: 10px; }
    
    .val-abnormal { color: #DC2626; font-weight: 800; }
    .val-normal { color: #16A34A; font-weight: 700; }

    /* Hidden Source for JS Processing */
    #reportSource { display: none; }

    /* Print Styles */
    @media print {
        * { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; color-adjust: exact !important; }
        body, html { background: #fff !important; margin: 0 !important; padding: 0 !important; height: 100%; }
        .admin-sidebar, .admin-topbar, .preview-actions, .tpl-section { display: none !important; }
        .admin-main, .admin-content { margin: 0 !important; padding: 0 !important; width: 100%; display: block; }
        .report-container { display: block !important; margin: 0 !important; padding: 0 !important; gap: 0 !important; }
        .report-page { 
            box-shadow: none; 
            margin: 0 auto !important; /* Centered */
            /* REDUCED SIZE as per request */
            width: 200mm;   /* 10mm less than A4 */
            height: 280mm;  /* 17mm less than A4 */
            
            break-after: page; page-break-after: always; 
            overflow: hidden; 
            position: relative;
            border: 1px solid transparent; /* Force box calculation */
        }
        .report-page:last-child { break-after: auto; page-break-after: auto; }
        @page { size: A4; margin: 0; }
    }
</style>

<!-- Action Bar -->
<div class="preview-actions">
    <div class="act-left">
        <a href="{{ url_for('admin.reports') }}" class="btn-act btn-back"><i class="fas fa-arrow-left"></i> Back</a>
        <button class="btn-act btn-print" onclick="window.print()"><i class="fas fa-print"></i> Print</button>
        {% if report.file_path %}
        <a href="{{ url_for('main.download_report', report_id=report.id) }}" class="btn-act btn-dl"><i class="fas fa-file-pdf"></i> Download PDF</a>
        {% endif %}
    </div>
    <div class="report-meta">
        <span style="color:#94A3B8; font-size:12px;">Report ID: <strong>{{ report.report_id }}</strong></span>
    </div>
</div>

<!-- Template Thumbnails -->
<div class="tpl-section">
    <div class="tpl-header">
        <span>Select Print Background</span>
        <a href="{{ url_for('admin.report_templates') }}" style="color:var(--admin-primary); text-decoration:none;">Manage Templates &rarr;</a>
    </div>
    <div class="tpl-thumbs">
        <!-- Default: No Template -->
        <div class="tpl-item active" onclick="setTemplate('', this)">
            <div class="tpl-img" style="background:#fff; display:flex; align-items:center; justify-content:center; color:#ccc;">
                <i class="fas fa-ban"></i>
            </div>
            <div class="tpl-name">None</div>
        </div>
        <!-- Uploaded Templates -->
        {% for t in templates %}
        <div class="tpl-item" onclick="setTemplate('{{ url_for('static', filename='images/templates/' + t.file_path) }}', this)">
            <img src="{{ url_for('static', filename='images/templates/' + t.file_path) }}" class="tpl-img">
            <div class="tpl-name">{{ t.name }}</div>
        </div>
        {% endfor %}
    </div>
</div>

<!-- LIVE PREVIEW CONTAINER -->
<div class="report-container" id="reportViewer">
    <!-- JS will render pages here -->
</div>

<!-- HIDDEN DATA SOURCE (Raw HTML to be paginated) -->
<div id="reportSource">
    <!-- Patient Info -->
    <div id="srcPatientInfo">
        <div class="section-header first">Patient Information</div>
        <table class="info-table">
            <tr>
                <td class="lbl">Name</td><td class="val">{{ report.patient_name }}</td>
                <td class="lbl">Report ID</td><td class="val">{{ report.report_id }}</td>
            </tr>
            <tr>
                <td class="lbl">Age/Sex</td><td class="val">{{ report.age }} Yrs / {{ report.gender }}</td>
                <td class="lbl">Date</td><td class="val">{{ report.uploaded_at.strftime('%d/%m/%Y %I:%M %p') }}</td>
            </tr>
            <tr>
                <td class="lbl">Ref. Dr</td><td class="val">{{ report.doctor_name or 'Self' }}</td>
                <td class="lbl">Sample ID</td><td class="val">{{ report.token_number }}</td>
            </tr>
            <tr>
                <td class="lbl">Phone</td><td class="val">{{ report.phone|default('N/A', true) }}</td>
                <td class="lbl">Collected</td><td class="val">{{ report.collected_at|default('Lab', true) }} ({{ report.collection_date|default('N/A', true) }})</td>
            </tr>
            <tr>
                <td class="lbl">Test</td><td class="val" colspan="3" style="color:#000;">{{ report.test_name }}</td>
            </tr>
        </table>
    </div>

    <!-- Results Rows (Data only) -->
    <table id="srcResults">
        {% for r in test_results %}
        <tr>
            <td style="width:5%">{{ loop.index }}</td>
            <td style="width:35%" class="p-name">{{ r.parameter }}</td>
            <td style="width:20%">
                {% set val = r.value|string %}
                {% set rng = r.normal_range|default('', true) %}
                {% set is_abnormal = false %}
                {% if val and rng %}
                    {# Simple numeric check #}
                     {% set v = val|float(default=None) %}
                     {% if v is not none %}
                        {% if ' - ' in rng %}
                            {% set p = rng.split(' - ') %}
                            {% if p|length == 2 %}
                                {% if v < p[0]|float or v > p[1]|float %}{% set is_abnormal = true %}{% endif %}
                            {% endif %}
                        {% elif '-' in rng and rng.replace('.','').replace('-','').isdigit() %}
                             {% set p = rng.split('-') %}
                             {% if p|length == 2 %}
                                {% if v < p[0]|float or v > p[1]|float %}{% set is_abnormal = true %}{% endif %}
                             {% endif %}
                        {% endif %}
                     {% endif %}
                {% endif %}
                
                {% if is_abnormal %}
                    <span class="val-abnormal">{{ val }} *</span>
                {% else %}
                    <span class="val-normal">{{ val }}</span>
                {% endif %}
            </td>
            <td style="width:10%">{{ r.unit }}</td>
            <td style="width:30%">{{ r.normal_range }}</td>
        </tr>
        {% endfor %}
    </table>

    <!-- Generic Footer Stuff -->
    <div id="srcFooter">
        {% if report.remarks %}
        <div style="margin-top:14px; font-size:11px; border:1px solid #ccc; background:#ffffef; padding:8px;">
            <strong>Remarks:</strong> {{ report.remarks }}
        </div>
        {% endif %}
        
        <div style="margin-top:20px; font-size:10px; text-align:center; color:#666;">
            *** End of Report ***
        </div>
    </div>
</div>

<script>
let currentTemplateUrl = '';

function setTemplate(url, el) {
    currentTemplateUrl = url;
    document.querySelectorAll('.tpl-item').forEach(i => i.classList.remove('active'));
    el.classList.add('active');
    
    // Update all existing pages
    document.querySelectorAll('.tpl-bg').forEach(img => {
        img.src = url;
        img.style.display = url ? 'block' : 'none';
    });
}

// ── PAGINATION LOGIC ──
function paginateReport() {
    console.log("Paginating Report...");
    const viewer = document.getElementById('reportViewer');
    viewer.innerHTML = ''; // Clear current

    const srcPatient = document.getElementById('srcPatientInfo').innerHTML;
    const srcRows = Array.from(document.querySelectorAll('#srcResults tr'));
    const srcFooter = document.getElementById('srcFooter').innerHTML;

    let pageNum = 1;
    let currPage = createPage(pageNum);
    let currContent = currPage.querySelector('.page-content');
    
    // 1. Add Patient Info (Page 1 only)
    let pInfo = document.createElement('div');
    pInfo.innerHTML = srcPatient;
    currContent.appendChild(pInfo);

    // 2. Start Results Table
    let table = createTableStructure();
    let tbody = table.querySelector('tbody');
    currContent.appendChild(table);

    // Header for results
    let resHeader = document.createElement('div');
    resHeader.className = 'section-header';
    resHeader.textContent = 'Test Results';
    currContent.insertBefore(resHeader, table);

    // 3. Add rows one by one
    for (let i = 0; i < srcRows.length; i++) {
        let row = srcRows[i].cloneNode(true);
        tbody.appendChild(row);

        // Check overflow
        if (checkOverflow(currContent)) {
            console.log("Overflow at row " + i + ", starting new page.");
            tbody.removeChild(row);
            
            // Create NEW page
            pageNum++;
            currPage = createPage(pageNum);
            currContent = currPage.querySelector('.page-content');
            
            // Add continued header
            let contHeader = document.createElement('div');
            contHeader.className = 'section-header first'; 
            contHeader.textContent = 'Test Results (Cont.)';
            currContent.appendChild(contHeader);
            
            // Start new table
            table = createTableStructure();
            tbody = table.querySelector('tbody');
            currContent.appendChild(table);
            
            // Add the row there
            tbody.appendChild(row);
        }
    }

    // 4. Add Footer / Remarks
    let fDiv = document.createElement('div');
    fDiv.innerHTML = srcFooter;
    currContent.appendChild(fDiv);

    // Check overflow again
    if (checkOverflow(currContent)) {
        console.log("Overflow at footer, moving footer to new page.");
        currContent.removeChild(fDiv);
         // Create NEW page just for footer
         pageNum++;
         currPage = createPage(pageNum);
         currContent = currPage.querySelector('.page-content');
         currContent.appendChild(fDiv);
    }
}

function checkOverflow(contentDiv) {
    // Reduced page height to 280mm (~1058px) in print.
    // Content should fit within this reduced height.
    // Top Padding = 204px.
    // Footer Start = 280mm - 52mm = 228mm (~862px).
    // Buffer = 12px.
    // Limit = 850px.
    
    const LIMIT_PX = 850;
    
    const lastEl = contentDiv.lastElementChild;
    if (!lastEl) return false;
    
    const bottom = lastEl.offsetTop + lastEl.offsetHeight;
    
    return bottom > LIMIT_PX;
}

function createPage(num) {
    const p = document.createElement('div');
    p.className = 'report-page';
    p.id = 'page-' + num;
    p.innerHTML = `<img src="${currentTemplateUrl}" class="tpl-bg" style="display:${currentTemplateUrl?'block':'none'}"><div class="page-content"></div>`;
    document.getElementById('reportViewer').appendChild(p);
    return p;
}

function createTableStructure() {
    const t = document.createElement('table');
    t.className = 'results-table';
    t.innerHTML = `
        <thead>
            <tr>
                <th style="width:5%">#</th>
                <th style="width:35%">Parameter</th>
                <th style="width:20%">Result</th>
                <th style="width:10%">Unit</th>
                <th style="width:30%">Normal Range</th>
            </tr>
        </thead>
        <tbody></tbody>
    `;
    return t;
}

// Initial Run
window.onload = function() {
    paginateReport();
};
</script>
{% endblock %}
