{% extends 'admin/admin_base.html' %}
{% block title %}Create Report{% endblock %}
{% block page_title %}Create Report{% endblock %}

{% block content %}
<style>
    .cr-form { background: var(--admin-card-bg); border-radius: 14px; padding: 28px 32px; }
    .cr-section { margin-bottom: 24px; }
    .cr-section h3 { font-size: 15px; font-weight: 700; color: var(--admin-primary);
        border-bottom: 2px solid var(--admin-primary); padding-bottom: 8px; margin-bottom: 16px;
        display: flex; align-items: center; gap: 8px; }
    .cr-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 14px; }
    .cr-field label { display: block; font-size: 12px; font-weight: 600; color: #94A3B8;
        text-transform: uppercase; letter-spacing: .5px; margin-bottom: 5px; }
    .cr-field input, .cr-field select, .cr-field textarea {
        width: 100%; padding: 10px 14px; border: 1px solid rgba(255,255,255,0.08);
        border-radius: 8px; background: rgba(255,255,255,0.04); color: var(--admin-text);
        font-size: 14px; transition: border-color .2s; box-sizing: border-box; }
    .cr-field input:focus, .cr-field select:focus { border-color: var(--admin-primary); outline: none; }
    .cr-field select { cursor: pointer; background-color: #1E293B; color: #E2E8F0; }
    .cr-field select option { background: #1E293B; color: #E2E8F0; }
    .cr-field select optgroup { background: #0F172A; color: #94A3B8; }

    /* Phone field with country code */
    .phone-row { display: flex; gap: 8px; }
    .phone-row select { width: 110px; flex-shrink: 0; font-size: 12px; padding: 10px 6px;
        background-color: #1E293B; color: #E2E8F0; border: 1px solid rgba(255,255,255,0.08);
        border-radius: 8px; }
    .phone-row select option { background: #1E293B; color: #E2E8F0; }
    .phone-row input { flex: 1; }

    /* Parameters table */
    .param-table { width: 100%; border-collapse: collapse; margin-top: 12px; }
    .param-table th { background: var(--admin-primary); color: #fff; padding: 10px 14px;
        font-size: 12px; text-transform: uppercase; letter-spacing: .5px; font-weight: 700; }
    .param-table th:first-child { border-radius: 8px 0 0 0; }
    .param-table th:last-child { border-radius: 0 8px 0 0; }
    .param-table td { padding: 8px 10px; border-bottom: 1px solid rgba(255,255,255,0.06); }
    .param-table input { width: 100%; padding: 8px 10px; border: 1px solid rgba(255,255,255,0.08);
        border-radius: 6px; background: rgba(255,255,255,0.04); color: var(--admin-text);
        font-size: 13px; box-sizing: border-box; }
    .param-table input:focus { border-color: var(--admin-primary); outline: none; }
    .param-table .value-input { background: rgba(59,130,246,0.08); border-color: rgba(59,130,246,0.3);
        font-weight: 600; }
    .param-table .readonly { opacity: 0.7; }
    .param-row-remove { background: none; border: none; color: var(--admin-danger);
        cursor: pointer; font-size: 16px; padding: 4px; }

    .params-loading { text-align: center; padding: 30px; color: #94A3B8; }
    .params-empty { text-align: center; padding: 20px; color: #64748B; font-style: italic; }

    /* Searchable Test Dropdown */
    .test-search-wrap { position: relative; }
    .test-search-input { width: 100%; padding: 10px 14px 10px 36px; border: 1px solid rgba(255,255,255,0.08);
        border-radius: 8px; background: rgba(255,255,255,0.04); color: var(--admin-text);
        font-size: 14px; box-sizing: border-box; }
    .test-search-input:focus { border-color: var(--admin-primary); outline: none; }
    .test-search-icon { position: absolute; left: 12px; top: 50%; transform: translateY(-50%);
        color: #64748B; font-size: 14px; pointer-events: none; }
    .test-dropdown { position: absolute; top: 100%; left: 0; right: 0; max-height: 280px;
        overflow-y: auto; background: #1E293B; border: 1px solid rgba(59,130,246,0.4);
        border-radius: 0 0 10px 10px; z-index: 50; display: none; box-shadow: 0 12px 30px rgba(0,0,0,0.5); }
    .test-dropdown.show { display: block; }
    .test-dd-group { padding: 6px 12px; font-size: 11px; font-weight: 700; color: #64748B;
        text-transform: uppercase; letter-spacing: .5px; background: #0F172A; }
    .test-dd-item { padding: 10px 16px; cursor: pointer; font-size: 13px; color: #E2E8F0;
        transition: background .15s; }
    .test-dd-item:hover, .test-dd-item.active { background: rgba(59,130,246,0.2); }
    .test-dd-item.hidden { display: none; }

    .test-badge { display: inline-block; padding: 2px 10px; border-radius: 20px;
        font-size: 11px; font-weight: 600; background: rgba(59,130,246,0.15);
        color: var(--admin-primary); margin-left: 6px; }

    .cr-submit { display: flex; gap: 12px; justify-content: flex-end; padding-top: 16px;
        border-top: 1px solid rgba(255,255,255,0.06); margin-top: 20px; }
    .btn-create { background: linear-gradient(135deg, var(--admin-primary), #2563EB);
        color: #fff; border: none; padding: 12px 32px; border-radius: 10px;
        font-weight: 700; font-size: 15px; cursor: pointer; transition: transform .2s, box-shadow .2s; }
    .btn-create:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(59,130,246,0.35); }
    .btn-add-row { background: rgba(16,185,129,0.15); color: var(--admin-success);
        border: 1px dashed rgba(16,185,129,0.4); padding: 8px 18px; border-radius: 8px;
        cursor: pointer; font-size: 13px; font-weight: 600; margin-top: 10px; }
    .btn-add-row:hover { background: rgba(16,185,129,0.25); }
</style>

<form method="POST" class="cr-form" id="createReportForm">
    <!-- Patient Details -->
    <div class="cr-section">
        <h3><i class="fas fa-user-injured"></i> Patient Details</h3>
        <div class="cr-grid">
            <div class="cr-field">
                <label>Patient Name *</label>
                <input type="text" name="patient_name" required placeholder="Full name">
            </div>
            <div class="cr-field">
                <label>Age</label>
                <input type="number" name="age" min="0" max="150" placeholder="Years">
            </div>
            <div class="cr-field">
                <label>Gender</label>
                <select name="gender">
                    <option value="">Select</option>
                    <option value="Male">Male</option>
                    <option value="Female">Female</option>
                    <option value="Other">Other</option>
                </select>
            </div>
            <div class="cr-field">
                <label>Phone No.</label>
                <div class="phone-row">
                    <select name="country_code">
                        <option value="+91" selected>IN +91</option>
                        <option value="+1">US +1</option>
                        <option value="+44">UK +44</option>
                        <option value="+971">AE +971</option>
                        <option value="+966">SA +966</option>
                        <option value="+65">SG +65</option>
                        <option value="+61">AU +61</option>
                        <option value="+977">NP +977</option>
                        <option value="+880">BD +880</option>
                        <option value="+92">PK +92</option>
                    </select>
                    <input type="text" name="phone" placeholder="XXXXX XXXXX" maxlength="15">
                </div>
            </div>
            <div class="cr-field">
                <label>Referring Doctor</label>
                <input type="text" name="doctor_name" placeholder="Dr. Name">
            </div>
            <div class="cr-field">
                <label>Sample ID</label>
                <input type="text" name="sample_id" placeholder="Auto-generated if empty">
            </div>
            <div class="cr-field">
                <label>Sample Type</label>
                <input type="text" name="sample_type" id="sampleType" value="Blood" placeholder="Blood/Urine">
            </div>
            <div class="cr-field">
                <label>Collection Date</label>
                <input type="date" name="collection_date">
            </div>
            <div class="cr-field">
                <label>Report Time</label>
                <input type="text" name="report_time" placeholder="e.g. 24 Hrs">
            </div>
            <div class="cr-field">
                <label>Collected At</label>
                <input type="text" name="collected_at" value="Lab" placeholder="Lab / Home">
            </div>
        </div>
    </div>

    <!-- Test Selection with Search -->
    <div class="cr-section">
        <h3><i class="fas fa-vial"></i> Select Test</h3>
        <div class="cr-grid">
            <div class="cr-field" style="grid-column: 1 / -1; max-width: 500px;">
                <label>Test *</label>
                <!-- Hidden actual inputs -->
                <input type="hidden" name="test_id" id="testIdHidden" required>
                <input type="hidden" name="test_name" id="testNameHidden">

                <div class="test-search-wrap" id="testSearchWrap">
                    <i class="fas fa-search test-search-icon"></i>
                    <input type="text" class="test-search-input" id="testSearchInput"
                           placeholder="Search test by name..." autocomplete="off">
                    <div class="test-dropdown" id="testDropdown">
                        {% for cat in categories %}
                        <div class="test-dd-group">{{ cat.icon }} {{ cat.name }}</div>
                        {% for t in tests if t.category_id == cat.id %}
                        <div class="test-dd-item" data-id="{{ t.id }}"
                             data-name="{{ t.name }}" data-sample="{{ t.sample_type }}">
                            {{ t.name }}
                        </div>
                        {% endfor %}
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Test Parameters -->
    <div class="cr-section">
        <h3><i class="fas fa-list-ol"></i> Test Parameters
            <span id="paramCount" class="test-badge" style="display:none">0 params</span>
        </h3>
        <div id="paramsLoading" class="params-loading" style="display:none;">
            <i class="fas fa-spinner fa-spin"></i> Loading parameters...
        </div>
        <div id="paramsEmpty" class="params-empty">
            Search and select a test to load parameters
        </div>
        <table class="param-table" id="paramsTable" style="display:none;">
            <thead>
                <tr>
                    <th style="width:30%">Parameter</th>
                    <th style="width:20%">Result Value</th>
                    <th style="width:15%">Unit</th>
                    <th style="width:25%">Normal Range</th>
                    <th style="width:10%"></th>
                </tr>
            </thead>
            <tbody id="paramsBody"></tbody>
        </table>
        <button type="button" class="btn-add-row" id="addRowBtn" style="display:none;"
                onclick="addCustomRow()">
            <i class="fas fa-plus"></i> Add Custom Parameter
        </button>
    </div>

    <!-- Remarks -->
    <div class="cr-section">
        <h3><i class="fas fa-clipboard"></i> Remarks</h3>
        <div class="cr-field">
            <textarea name="remarks" rows="3" placeholder="Any additional notes (optional)"></textarea>
        </div>
    </div>

    <!-- Submit -->
    <div class="cr-submit">
        <a href="{{ url_for('admin.reports') }}" class="btn-create"
           style="background:rgba(255,255,255,0.06); color:#94A3B8;">Cancel</a>
        <button type="submit" class="btn-create">
            <i class="fas fa-file-pdf"></i> Generate Report
        </button>
    </div>
</form>

<script>
/* ── Searchable Test Dropdown ── */
const searchInput = document.getElementById('testSearchInput');
const dropdown = document.getElementById('testDropdown');
const testIdHidden = document.getElementById('testIdHidden');
const testNameHidden = document.getElementById('testNameHidden');
const sampleType = document.getElementById('sampleType');
const items = dropdown.querySelectorAll('.test-dd-item');
const groups = dropdown.querySelectorAll('.test-dd-group');

searchInput.addEventListener('focus', () => dropdown.classList.add('show'));
searchInput.addEventListener('input', () => {
    const q = searchInput.value.toLowerCase();
    dropdown.classList.add('show');
    items.forEach(it => {
        const match = it.textContent.toLowerCase().includes(q);
        it.classList.toggle('hidden', !match);
    });
    // Show/hide group headers based on if any children visible
    groups.forEach(g => {
        let next = g.nextElementSibling;
        let hasVisible = false;
        while (next && !next.classList.contains('test-dd-group')) {
            if (!next.classList.contains('hidden')) hasVisible = true;
            next = next.nextElementSibling;
        }
        g.style.display = hasVisible ? '' : 'none';
    });
});

items.forEach(it => {
    it.addEventListener('click', () => {
        testIdHidden.value = it.dataset.id;
        testNameHidden.value = it.dataset.name;
        searchInput.value = it.dataset.name;
        if (it.dataset.sample) sampleType.value = it.dataset.sample;
        dropdown.classList.remove('show');
        loadParams(it.dataset.id);
    });
});

document.addEventListener('click', e => {
    if (!document.getElementById('testSearchWrap').contains(e.target)) {
        dropdown.classList.remove('show');
    }
});

/* ── Load Parameters ── */
const paramsBody = document.getElementById('paramsBody');
const paramsTable = document.getElementById('paramsTable');
const paramsLoading = document.getElementById('paramsLoading');
const paramsEmpty = document.getElementById('paramsEmpty');
const paramCount = document.getElementById('paramCount');
const addRowBtn = document.getElementById('addRowBtn');

async function loadParams(testId) {
    paramsLoading.style.display = 'block';
    paramsEmpty.style.display = 'none';
    paramsTable.style.display = 'none';

    try {
        const res = await fetch(`/admin/api/test-parameters/${testId}`);
        const data = await res.json();
        paramsBody.innerHTML = '';

        if (data.parameters.length === 0) {
            paramsEmpty.style.display = 'block';
            paramsEmpty.textContent = 'No parameters defined. Add custom rows below.';
            paramsTable.style.display = 'none';
        } else {
            data.parameters.forEach(p => {
                addParamRow(p.parameter_name, '', p.unit, p.normal_range_text);
            });
            paramsTable.style.display = 'table';
            paramsEmpty.style.display = 'none';
        }
        paramCount.textContent = `${data.parameters.length} params`;
        paramCount.style.display = 'inline-block';
        addRowBtn.style.display = 'block';
    } catch (err) {
        paramsEmpty.textContent = 'Error loading parameters';
        paramsEmpty.style.display = 'block';
    }
    paramsLoading.style.display = 'none';
}

function addParamRow(name, value, unit, range) {
    const row = document.createElement('tr');
    row.innerHTML = `
        <td><input type="text" name="param_name[]" value="${escHtml(name)}" class="readonly"></td>
        <td><input type="text" name="param_value[]" value="${escHtml(value)}" class="value-input"
                   placeholder="Enter result"></td>
        <td><input type="text" name="param_unit[]" value="${escHtml(unit)}" class="readonly"></td>
        <td><input type="text" name="param_range[]" value="${escHtml(range)}" class="readonly"></td>
        <td><button type="button" class="param-row-remove" onclick="this.closest('tr').remove();updateCount();">
            <i class="fas fa-times"></i></button></td>
    `;
    paramsBody.appendChild(row);
    updateCount();
}

function addCustomRow() {
    addParamRow('', '', '', '');
    paramsTable.style.display = 'table';
    const rows = paramsBody.querySelectorAll('tr');
    rows[rows.length - 1].querySelector('input').focus();
}

function updateCount() {
    paramCount.textContent = `${paramsBody.querySelectorAll('tr').length} params`;
}

function escHtml(s) {
    const d = document.createElement('div');
    d.textContent = s || '';
    return d.innerHTML;
}

document.getElementById('createReportForm').addEventListener('submit', function(e) {
    if (!testIdHidden.value) { e.preventDefault(); alert('Please select a test.'); return; }
    const vals = document.querySelectorAll('.value-input');
    let empty = 0;
    vals.forEach(v => { if (!v.value.trim()) empty++; });
    if (empty > 0 && !confirm(`${empty} parameter value(s) are empty. Continue anyway?`)) {
        e.preventDefault();
    }
});
</script>
{% endblock %}
