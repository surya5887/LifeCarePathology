{% extends 'admin/admin_base.html' %}
{% block title %}Analytics{% endblock %}
{% block page_title %}Revenue & Analytics{% endblock %}

{% block content %}
<style>
    .analytics-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 28px; }
    .analytics-card { background: var(--admin-surface); border: 1px solid var(--admin-border); border-radius: var(--admin-radius); padding: 24px; }
    .analytics-card h4 { font-size: 12px; color: var(--admin-text-muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px; }
    .analytics-card .big-number { font-size: 32px; font-weight: 800; }
    .analytics-card .big-number.revenue { color: var(--admin-success); }
    .analytics-card .big-number.bookings { color: var(--admin-info); }
    .analytics-two-col { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 28px; }
    @media(max-width:768px) { .analytics-two-col { grid-template-columns: 1fr; } }
    .analytics-list-card { background: var(--admin-surface); border: 1px solid var(--admin-border); border-radius: var(--admin-radius); padding: 24px; }
    .analytics-list-card h3 { font-size: 16px; font-weight: 700; margin-bottom: 16px; display: flex; align-items: center; gap: 8px; }
    .analytics-list-card h3 i { color: var(--admin-primary-light); }
    .top-test-item { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid var(--admin-border); font-size: 14px; }
    .top-test-item:last-child { border-bottom: none; }
    .top-test-item .count { color: var(--admin-primary-light); font-weight: 700; }
    .status-breakdown { display: flex; flex-wrap: wrap; gap: 12px; }
    .status-item { display: flex; align-items: center; gap: 8px; padding: 10px 16px; background: var(--admin-surface-2); border-radius: 8px; font-size: 14px; }
    .status-dot { width: 10px; height: 10px; border-radius: 50%; }
    .activity-item { padding: 10px 0; border-bottom: 1px solid var(--admin-border); }
    .activity-item:last-child { border-bottom: none; }
    .activity-item .action { font-size: 14px; font-weight: 500; }
    .activity-item .details { font-size: 12px; color: var(--admin-text-muted); }
    .activity-item .time { font-size: 11px; color: var(--admin-text-muted); margin-top: 2px; }
    .export-row { display: flex; gap: 12px; flex-wrap: wrap; margin-bottom: 28px; }
</style>

<div class="admin-page-header">
    <div>
        <h1><i class="fas fa-chart-line"></i> Revenue & <span class="gradient-text">Analytics</span></h1>
        <p>Track revenue, bookings, and performance metrics.</p>
    </div>
</div>

<!-- Export Buttons -->
<div class="export-row">
    <a href="{{ url_for('admin.export_patients') }}" class="btn btn-outline btn-sm"><i class="fas fa-download"></i> Export Patients</a>
    <a href="{{ url_for('admin.export_bookings') }}" class="btn btn-outline btn-sm"><i class="fas fa-download"></i> Export Bookings</a>
    <a href="{{ url_for('admin.export_reports') }}" class="btn btn-outline btn-sm"><i class="fas fa-download"></i> Export Reports</a>
</div>

<!-- Revenue Cards -->
<div class="analytics-row">
    <div class="analytics-card">
        <h4>Today's Revenue</h4>
        <div class="big-number revenue">₹{{ "%.0f"|format(today_revenue) }}</div>
    </div>
    <div class="analytics-card">
        <h4>Monthly Revenue</h4>
        <div class="big-number revenue">₹{{ "%.0f"|format(monthly_revenue) }}</div>
    </div>
    <div class="analytics-card">
        <h4>Total Revenue (All Time)</h4>
        <div class="big-number revenue">₹{{ "%.0f"|format(total_revenue) }}</div>
    </div>
    <div class="analytics-card">
        <h4>Today's Bookings</h4>
        <div class="big-number bookings">{{ today_bookings }}</div>
    </div>
    <div class="analytics-card">
        <h4>Monthly Bookings</h4>
        <div class="big-number bookings">{{ monthly_bookings }}</div>
    </div>
</div>

<!-- Two Column -->
<div class="analytics-two-col">
    <!-- Top Tests -->
    <div class="analytics-list-card">
        <h3><i class="fas fa-trophy"></i> Most Booked Tests</h3>
        {% if top_tests %}
            {% for name, count in top_tests %}
            <div class="top-test-item">
                <span>{{ name }}</span>
                <span class="count">{{ count }} bookings</span>
            </div>
            {% endfor %}
        {% else %}
            <p style="color:var(--admin-text-muted);font-size:14px">No booking data yet.</p>
        {% endif %}
    </div>

    <!-- Booking Status -->
    <div class="analytics-list-card">
        <h3><i class="fas fa-pie-chart"></i> Booking Status Breakdown</h3>
        <div class="status-breakdown">
            <div class="status-item">
                <div class="status-dot" style="background:var(--admin-warning)"></div>
                Pending: <strong>{{ status_counts.get('pending', 0) }}</strong>
            </div>
            <div class="status-item">
                <div class="status-dot" style="background:var(--admin-info)"></div>
                Confirmed: <strong>{{ status_counts.get('confirmed', 0) }}</strong>
            </div>
            <div class="status-item">
                <div class="status-dot" style="background:var(--admin-success)"></div>
                Completed: <strong>{{ status_counts.get('completed', 0) }}</strong>
            </div>
            <div class="status-item">
                <div class="status-dot" style="background:var(--admin-danger)"></div>
                Cancelled: <strong>{{ status_counts.get('cancelled', 0) }}</strong>
            </div>
        </div>
    </div>
</div>

<!-- Recent Activity -->
<div class="analytics-list-card">
    <h3><i class="fas fa-history"></i> Recent Admin Activity</h3>
    {% if recent_activity %}
        {% for log in recent_activity %}
        <div class="activity-item">
            <div class="action">{{ log.action }}</div>
            {% if log.details %}<div class="details">{{ log.details }}</div>{% endif %}
            <div class="time">{{ log.created_at.strftime('%d %b %Y, %I:%M %p') }} — {{ log.admin.name }}</div>
        </div>
        {% endfor %}
    {% else %}
        <p style="color:var(--admin-text-muted);font-size:14px">No activity logged yet.</p>
    {% endif %}
</div>
{% endblock %}
